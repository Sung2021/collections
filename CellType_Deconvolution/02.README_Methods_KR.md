# Deconvolution 방법론 정리 (한국어)

## 📌 Deconvolution이란?

**Deconvolution**은 bulk RNA-seq 데이터에서 **각 cell type의 비율**을 추정하는 분석 방법입니다.

### 기본 원리

```
Bulk RNA-seq = Σ (Cell type 비율 × Cell type의 발현 프로파일)
```

수식으로 표현하면:
```
Y = X × β

Y: Bulk RNA-seq 발현량 (유전자 × 샘플)
X: Signature matrix (유전자 × Cell type)
β: Cell type 비율 (Cell type × 샘플) ← 우리가 구하려는 값!
```

### 목표
알려진 X (signature matrix)와 Y (bulk data)로부터 **β (cell type 비율)**을 추정

---

## 🔬 4가지 Deconvolution 방법

### 1. NNLS (Non-Negative Least Squares)

#### 원리
- **최소자승법** (Least Squares)에 **비음수 제약조건** 추가
- Cell type 비율은 0 이상이어야 한다는 생물학적 제약 반영

#### 수식
```
minimize: ||Y - X×β||²
subject to: β ≥ 0
```

#### 장점
✅ 생물학적으로 타당 (음수 비율 없음)  
✅ 안정적이고 빠름  
✅ 대부분의 경우 좋은 성능  

#### 단점
❌ Sum-to-1 제약 없음 (비율 합이 정확히 1이 아닐 수 있음)  
❌ Outlier에 민감  

#### 언제 사용?
- **기본 선택**: 대부분의 경우 첫 번째 시도
- 데이터가 깨끗하고 노이즈가 적을 때

#### R 코드
```r
library(nnls)

deconvolve_nnls <- function(bulk, signature) {
  fit <- nnls(A = as.matrix(signature), b = bulk)
  prop <- coef(fit)
  prop <- prop / sum(prop)  # Sum-to-1 정규화
  return(prop)
}
```

---

### 2. QP (Quadratic Programming)

#### 원리
- NNLS와 유사하지만 **sum-to-1 제약조건 추가**
- Quadratic programming으로 최적화 문제를 엄밀하게 해결

#### 수식
```
minimize: ||Y - X×β||²
subject to: 
  - β ≥ 0
  - Σβᵢ = 1  ← sum-to-1 제약
```

#### 장점
✅ 정확한 비율 (합이 정확히 1)  
✅ 수학적으로 엄밀  
✅ 극단적 비율에서도 안정적  

#### 단점
❌ NNLS보다 약간 느림  
❌ Outlier에 민감  

#### 언제 사용?
- **정확한 비율**이 중요할 때
- 극단적 비율 (예: 90%, 5%, 5%) 예상될 때
- Reporting/Publication용으로 엄밀한 수치 필요할 때

#### R 코드
```r
library(quadprog)

deconvolve_qp <- function(bulk, signature) {
  n_types <- ncol(signature)
  
  # QP setup
  Dmat <- t(signature) %*% signature
  dvec <- t(signature) %*% bulk
  
  # Constraints: sum(β) = 1, β ≥ 0
  Amat <- cbind(rep(1, n_types), diag(n_types))
  bvec <- c(1, rep(0, n_types))
  
  result <- solve.QP(Dmat, dvec, Amat, bvec, meq = 1)
  return(result$solution)
}
```

---

### 3. Robust Regression

#### 원리
- **Huber loss** 사용: Outlier에 덜 민감한 손실 함수
- 극단값의 영향을 줄여 robust한 추정

#### 수식
```
minimize: Σ ρ(Yᵢ - X×β)

ρ(r) = { r²/2           if |r| ≤ k  (작은 오차)
       { k|r| - k²/2    if |r| > k  (큰 오차 - outlier)
```

#### 장점
✅ **Outlier에 강함** ⭐ (가장 큰 장점)  
✅ 노이즈 많은 데이터에서 안정적  
✅ Batch effect가 있을 때 유리  

#### 단점
❌ OLS보다 느림  
❌ 음수 비율 가능 (후처리 필요)  

#### 언제 사용?
- **현실 데이터**: 노이즈/outlier 많을 때
- Batch effect 의심될 때
- 데이터 품질 확신 못 할 때

#### R 코드
```r
library(MASS)

deconvolve_robust <- function(bulk, signature) {
  fit <- rlm(bulk ~ as.matrix(signature) - 1, maxit = 100)
  
  prop <- coef(fit)
  prop[prop < 0] <- 0  # 음수 제거
  prop <- prop / sum(prop)
  return(prop)
}
```

---

### 4. OLS (Ordinary Least Squares)

#### 원리
- 가장 기본적인 **선형 회귀**
- 제약조건 없이 단순히 오차 제곱합 최소화

#### 수식
```
minimize: ||Y - X×β||²
(no constraints)
```

#### 장점
✅ 가장 빠름  
✅ 구현 간단  
✅ 이론적으로 잘 알려짐  

#### 단점
❌ **음수 비율 가능** (생물학적으로 부적절)  
❌ Outlier에 매우 민감  
❌ 극단값에 영향 크게 받음  

#### 언제 사용?
- **Baseline 비교용**: 다른 방법과 성능 비교할 때
- 이상적인 조건 (깨끗한 데이터, 노이즈 적음)
- 교육/연구 목적

#### R 코드
```r
deconvolve_ols <- function(bulk, signature) {
  fit <- lm(bulk ~ as.matrix(signature) - 1)
  
  prop <- coef(fit)
  prop[prop < 0] <- 0  # 음수 제거
  prop <- prop / sum(prop)
  return(prop)
}
```

---

## 📊 방법론 비교 요약

| 방법 | 속도 | Outlier 저항성 | Sum-to-1 | 음수 방지 | 추천 사용 |
|------|------|----------------|----------|-----------|----------|
| **NNLS** | 빠름 | 보통 | ❌ (후처리) | ✅ | 기본 선택 |
| **QP** | 보통 | 보통 | ✅ | ✅ | 정확한 비율 필요 |
| **Robust** | 느림 | ✅ 강함 | ❌ (후처리) | ❌ (후처리) | 현실 데이터 |
| **OLS** | 매우 빠름 | ❌ 약함 | ❌ | ❌ | Baseline 비교 |

---

## 🎯 실전 사용 가이드

### 시나리오별 추천

#### 1️⃣ 깨끗한 데이터 (이상적 조건)
→ **NNLS** 또는 **QP**

#### 2️⃣ 노이즈 많은 현실 데이터
→ **Robust Regression** ⭐

#### 3️⃣ Batch effect 의심
→ **Robust Regression**

#### 4️⃣ 극단적 비율 예상 (예: 90/5/5)
→ **QP**

#### 5️⃣ 빠른 탐색 필요
→ **NNLS**

#### 6️⃣ 여러 방법 비교하고 싶을 때
→ **모든 방법 실행** 후 일치도 확인

---

## 💡 실전 팁

### 1. 여러 방법 동시 실행
```r
compare_methods <- function(bulk, signature, true_prop) {
  results <- data.frame(
    NNLS = deconvolve_nnls(bulk, signature),
    QP = deconvolve_qp(bulk, signature),
    Robust = deconvolve_robust(bulk, signature),
    OLS = deconvolve_ols(bulk, signature)
  )
  return(results)
}
```

### 2. 결과 일치도 확인
- 4가지 방법 결과가 **비슷하면** → 데이터 좋음, 결과 신뢰 가능
- 4가지 방법 결과가 **다르면** → 데이터 문제 의심, Robust 결과 우선

### 3. Validation 전략
- Ground truth 있으면: 실제 비율과 비교
- Ground truth 없으면: 
  - 여러 방법 일치도 확인
  - Simulation으로 테스트
  - 생물학적 prior knowledge 활용

---

## 📚 참고 문헌

1. **NNLS**: Lawson & Hanson (1974) "Solving Least Squares Problems"
2. **Quadratic Programming**: Goldfarb & Idnani (1983)
3. **Robust Regression**: Huber (1981) "Robust Statistics"
4. **Deconvolution Review**: Newman et al. (2019) Nature Methods

---

## 🔗 관련 파일

- `02.Deconvolution.Rmd`: 기본 비교 분석
- `02.Deconvolution_v2.Rmd`: Robustness 테스트 (노이즈, outlier 등)
- `01.read_h5ad_in_R.Rmd`: Signature matrix 생성

---

**작성일**: 2025-12-29  
**작성자**: Sungryeol Park
